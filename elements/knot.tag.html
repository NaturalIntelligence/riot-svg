<knot>
    <style>
        .knot-style{
            fill: lavender;
            fill-opacity: 0.5;
            stroke: gray;
            stroke-width: 1px;
            vector-effect: non-scaling-stroke;
            r: 5;
            cursor: pointer; /* crosshair */
        }
    </style>

    <circle ref={ keyName } class="knot-style" each={ point,keyName in parent.points } riot-cx={ point.x } riot-cy={ point.y } data-handler={ keyName } onmousedown={ pullStart }></circle>

    <script>
        var tag = this;
        var polygon = tag.parent;
        var svgBox,offset;

        this.updateKnot = updateKnot;
        this.shift = shift;
        this.startShift = startShift;

        this.on("mount", function() {
            //this.root.firstChild //svg wrapper
            //this.root.nearestViewportElement //parent SVG not the topmost

            /* if(this.parent.myParentNode){
                svgbox = this.parent.myParentNode;
            }else{
                if(this.parent.root.parentNode){
                    svgbox = this.parent.root.parentNode.nearestViewportElement;
                }
            }

            if(svgbox)  offset = svgbox.getBoundingClientRect(); */
        });
        
        tag.setParent = function(){
            if(this.parent.myParentSVGNode){
                svgbox = this.parent.myParentSVGNode;
                offset = this.parent.myParentSVGNode.getBoundingClientRect();
                //console.log(1, svgbox);
            }
        }

        function updateKnot(knotName, newXY){
            tag.refs[knotName].setAttribute("cx", newXY.x);
            tag.refs[knotName].setAttribute("cy", newXY.y);
        }

        /**
         * Shift all the knots as per the difference from the initial state
        */
        function shift( diffXY){
            var keys = Object.keys(this.parent.points);
            for(var i=0; i<keys.length; i++){
                var point = this.parent.points[ keys[i] ];
                point.x = this.initialState[  keys[i] ].x + diffXY.x;
                point.y = this.initialState[  keys[i] ].y + diffXY.y;
            }
            this.update();
        }

        function startShift(){
            this.initialState = clone( this.parent.points );
        }

        var knotInitialState;
        var selectedKnotId;

        tag.pullStart = (e) => {
            if(!svgbox) tag.setParent();
            selectedKnotId = e.target.dataset.handler;
            knotInitialState = clone( polygon.points[ selectedKnotId ] );
            polygon.moveStart( selectedKnotId );
            
            tag.parent.myParentSVGNode.addEventListener("mousemove", tag.pull );
            tag.parent.myParentSVGNode.addEventListener("mouseup", tag.pullStop );

            /* svgbox.addEventListener("mousemove", pull );
            svgbox.addEventListener("mouseup", pullStop ); */
        }

        tag.pull = (e) => {
            polygon.move(e);
            updateKnot(selectedKnotId, {
                x: e.x - this.parent.myParentSVGNode.getBoundingClientRect().x,
                y: e.y - this.parent.myParentSVGNode.getBoundingClientRect().y
            })
        }

        tag.pullStop = (e) => {
            polygon.moveStop();
            tag.parent.myParentSVGNode.removeEventListener("mousemove", tag.pull );
            tag.parent.myParentSVGNode.removeEventListener("mouseup", tag.pullStop );
        }


        function clone(obj){
            return JSON.parse(JSON.stringify( obj ));
        }
    </script>
</knot>