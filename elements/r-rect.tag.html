<r-rect>
    <style>
        .draggable{
            cursor: move;
        }
        .resize-handler{
            fill: lavender;
            fill-opacity: 0.5;
            stroke: gray;
            stroke-width: 1px;
            vector-effect: non-scaling-stroke;
            r: 5;
            cursor: pointer; /* crosshair */
        }
    </style>
    <rect ref="rect" onmousedown = {hold} class={draggable: draggable}/>
    <g ref="knots" if={resizable} class="resize-handlers hide" data-is="knot">
        <!-- <circle class="resize-handler" ref="nw" data-handler="nw" onmousedown={ holdTheHandler } ></circle>
        <circle class="resize-handler" ref="ne" data-handler="ne" onmousedown={ holdTheHandler } ></circle>
        <circle class="resize-handler" ref="sw" data-handler="sw" onmousedown={ holdTheHandler } ></circle>
        <circle class="resize-handler" ref="se" data-handler="se" onmousedown={ holdTheHandler } ></circle> -->
    </g>

    <script>
        var tag = this;
        tag.myParent = tag.parent || opts._parent;
        tag.diffX = 0;
        tag.diffY = 0;
        tag.dragStart = false;
        tag.hold = hold;
        tag.drag = drag;
        tag.release = release;

        tag.initialState = {};
        /* tag.holdTheHandler = holdTheHandler; */
        //tag.resize = resize;

        tag.selectRect = selectRect;

        tag.x= Number.parseInt(opts.x);
        tag.y= Number.parseInt(opts.y);
        tag.w= Number.parseInt(opts.width);
        tag.h= Number.parseInt(opts.height);

        tag._name= opts.name;
        tag.updatePosition = updatePosition;
        tag.setStartPosition = setStartPosition;
        tag.setResizeHandlersPosition = setResizeHandlersPosition;
        tag.draggable = (opts.draggable || opts.draggable === "true");
        tag.resizable = ( opts.resizable || opts.resizable === "true");

        tag.on("mount", function(e) {
            tag.myParent = tag.myParent || tag.parent || tag.root.parentNode;

            if(tag.myParent){
                if(tag.myParent.root){
                    tag.offset = {
                        x: tag.myParent.root.offsetLeft,
                        y: tag.myParent.root.offsetTop,
                    }
                    tag.myParentNode = tag.myParent.root;
                }else{
                    if(tag.myParent.tagName === "g"){
                        tag.myParent = tag.myParent.nearestViewportElement;
                    }
                    tag.offset = tag.myParent.getBoundingClientRect();
                    tag.myParentNode = tag.myParent;
                }
            }
            tag.refs.rect.setAttribute("x", opts.x);
            tag.refs.rect.setAttribute("y", opts.y);
            tag.refs.rect.setAttribute("width", tag.w);
            tag.refs.rect.setAttribute("height", tag.h);
            opts.rx && (tag.refs.rect.setAttribute("rx", opts.rx) );
            opts.ry && (tag.refs.rect.setAttribute("ry", opts.ry) );
            tag.setResizeHandlersPosition();

        })

        function setResizeHandlersPosition(){
            if(tag.resizable){

                tag.points = {
                    "ne" : {
                        x: tag.x + tag.w,
                        y: tag.y
                    },
                    "sw" : {
                        x: tag.x,
                        y: tag.y + tag.h
                    },
                    "se" : {
                        x: tag.x + tag.w,
                        y: tag.y + tag.h
                    },
                    "nw" : {
                        x: tag.x,
                        y: tag.y
                    }
                };

                tag.refs.knots.update();
                
            }
        }

        function selectRect(e){
            //
        }

        var dragHandler;

        tag.moveStart = ( knotName) =>{
            tag.initialState = { //in case of polygon you save initial state of connecting lines only
                x : tag.x,
                y : tag.y,
                w : tag.w,
                h : tag.h
            };
            dragHandler = tag[knotName];
        }

        tag.move = ( cursor ) =>{
            dragHandler && dragHandler(cursor);
        }

        tag.moveStop = ( cursor ) => {
            //doNothing
        }

        tag.se = function (cursor) {//change width & height both
            var x = tag.initialState.x;
            var y = tag.initialState.y;

            var cursorOffset = {
                x: cursor.x - tag.offset.x,
                y: cursor.y - tag.offset.y
            }
            if (cursorOffset.x < x) { 
                x = cursorOffset.x; 
            }
            if (cursorOffset.y < y) { 
                y = cursorOffset.y; 
            } 

            updateState(tag.refs.rect,{
                x: x,
                y: y,
                w: Math.abs(cursorOffset.x - tag.initialState.x) ,
                h: Math.abs(cursorOffset.y - tag.initialState.y) ,
            });
        }


        function updateState(el, state){
            tag.x =  state.x;
            tag.y =  state.y;
            tag.w =  state.w;
            tag.h =  state.h;

            
            el.setAttribute("x", state.x);
            el.setAttribute("y", state.y);
            el.setAttribute("width", state.w);
            el.setAttribute("height", state.h);
        }

        function updatePosition(cursor){
            //TODO: if keepWithIn is set then check if it is going out of container.
            var diff = {
                x:  cursor.x - tag.cursorStartPosition.x,
                y: cursor.y - tag.cursorStartPosition.y
            }
            
            tag.x = tag.beforeStart.x + diff.x;
            tag.y = tag.beforeStart.y + diff.y;

            tag.refs.rect.setAttribute("x", tag.x);
            tag.refs.rect.setAttribute("y", tag.y);

            if(tag.resizable){
                tag.refs.knots.shift(diff);//update initial position with this difference
            }
            //tag.update(); //it is required when there is any change in DOM element
        }

        function setStartPosition(e){
            tag.beforeStart = {
                x: tag.x,
                y: tag.y
            };
            tag.cursorStartPosition = {
                x: e.x,
                y: e.y
            };
        }

        function hold(e){
            if(tag.resizable){
                tag.refs.knots.startShift();//save initial position of all the points
            }
            tag.setStartPosition(e);

            if(tag.draggable){
                dragHandler = drag;

                tag.myParentNode.addEventListener("mousemove", drag);
                tag.myParentNode.addEventListener("mouseup", release);

                e.stopPropagation();
            }
        }

        function drag(e){
            tag.updatePosition(e);
        }

        function release(e){
            tag.myParentNode.removeEventListener("mousemove", dragHandler);
            tag.myParentNode.removeEventListener("mouseup", release);
        }

        /*
        svg.addEventListener('touchstart', startDrag);
        svg.addEventListener('touchmove', drag);
        svg.addEventListener('touchend', endDrag);
        svg.addEventListener('touchleave', endDrag);
        svg.addEventListener('touchcancel', endDrag);
        */
    </script>
</r-rect>